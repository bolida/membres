{% extends "base.html" %}

{% block title %}Modifier membre {{ membre.matricule }} - {{ membre.nom }}{% endblock %}

{% block content %}
  <h1 class="mb-3">Modifier membre {{ membre.matricule }} - {{ membre.nom }}</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-2">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'warning' if category == 'error' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="post" class="card" enctype="multipart/form-data">
    <div class="card-body">

      <h5 class="mb-3">Informations de base</h5>
	
	<div class="row g-3 mt-3">
	  <!-- Photo actuelle -->
	  <div class="col-md-4">
	    <label class="form-label">Photo actuelle</label><br>
	    {% if membre.photo %}
	      <img src="{{ url_for('static', filename='uploads/membres/' ~ membre.photo) }}"
		   alt="Photo de {{ membre.nom }}"
		   class="img-thumbnail mb-2"
		   style="max-width: 180px;">
	    {% else %}
	      <p class="text-muted">Aucune photo enregistrée.</p>
	    {% endif %}
	  </div>

	  <!-- Upload nouvelle photo -->
	  <div class="col-md-8">
	    <label class="form-label">Nouvelle photo</label>
	    <input type="file" name="photo" class="form-control">
	    <small class="text-muted">Formats : jpg, png… Taille max : 5 Mo.</small>
	  </div>
	</div>

	<hr class="my-4">

      <div class="row g-3">
      	
        <div class="col-md-4">
          <label class="form-label">Civilité *</label>
          <input type="text" name="civilite" class="form-control"
                 value="{{ membre.civilite or '' }}" required>
        </div>
        
        <div class="col-md-4">
          <label class="form-label">Matricule</label>
          <input type="text" class="form-control" value="{{ membre.matricule }}" disabled>
          <div class="form-text">Le matricule ne peut pas être modifié.</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Nom *</label>
          <input type="text" name="nom" class="form-control" value="{{ membre.nom }}" required>
        </div>

	<div class="col-md-4">
	    <label class="form-label">Date de naissance *</label>
	    <input type="date"
		   name="date_naissance"
		   class="form-control"
		   value="{{ membre.date_naissance|default('', true) }}" required>
	</div>
	  
        <div class="col-md-4">
          <label class="form-label">Famille *</label>
          <select name="famille_id" class="form-select">
            <option value="">-- Sélectionner une famille existante --</option>
            {% for f in familles %}
              <option value="{{ f.id }}" {% if membre.famille_id == f.id %}selected{% endif %}>{{ f.nom }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Ou bien créer une nouvelle famille :</div>
          <input type="text" name="nouvelle_famille"
                 class="form-control mt-1"
                 placeholder="Nom de la nouvelle famille">
        </div>
        
        <div class="col-md-4">
          <label class="form-label">Type *</label>
          <select name="type_membre" class="form-select" required>
            <option value="">-- Choisir --</option>
            <option value="Père" {% if membre.type_membre=='Père' %}selected{% endif %}>Père</option>
            <option value="Mère" {% if membre.type_membre=='Mère' %}selected{% endif %}>Mère</option>
            <option value="Enfant" {% if membre.type_membre=='Enfant' %}selected{% endif %}>Enfant</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Adresse initiale *</label>
          <input type="text" name="adresse_initiale" class="form-control"
                 value="{{ membre.adresse_initiale or '' }}" required>
        </div>
        
        <hr class="my-4">
        
        <div class="row g-3">
	  <div class="col-md-6">
	    <label class="form-label">Date de départ</label>
	    <input type="date"
		   name="date_depart"
		   class="form-control"
		   value="{{ membre.date_depart|default('', true) }}">
	  </div>

	  <div class="col-md-6">
	    <div class="form-check mt-4">
	      <input class="form-check-input"
		     type="checkbox"
		     name="est_mort"
		     id="est_mort"
		     {% if membre.est_mort %}checked{% endif %}>
	      <label class="form-check-label" for="est_mort">
		Membre décédé
	      </label>
	    </div>
	  </div>
	  
	  <div class="col-md-6">
		  <label class="form-label">Commentaire</label>
		  <textarea name="commentaire"
			    class="form-control"
			    rows="3">{{ membre.commentaire or '' }}</textarea>
		</div>

	  <div class="col-md-6">
	    <label class="form-label">Date de décès</label>
	    <input type="date"
		   name="date_mort_affichage"
		   id="date_mort_affichage"
		   class="form-control"
		   value="{{ membre.date_mort|default('', true) }}"
		   readonly>
	    <small class="text-muted">
	      Sera mise à jour automatiquement lors de l'enregistrement si "Membre décédé" est coché.
	    </small>
	  </div>
	</div>

	

        <div class="col-md-4">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" name="carte" id="carteCheck"
                   {% if membre.carte %}checked{% endif %}>
            <label class="form-check-label" for="carteCheck">Carte</label>
          </div>
        </div>

        <div class="col-md-4">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" name="souhait_avoir_carte" id="souhaitCheck"
                   {% if membre.souhait_avoir_carte %}checked{% endif %}>
            <label class="form-check-label" for="souhaitCheck">Souhaite avoir une carte</label>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <h5 class="mb-3">Bénédictions</h5>
      <p class="text-muted">
        Pour <strong>supprimer</strong> une ligne, effacez la bénédiction, le lieu et la date.
      </p>

      <div class="table-responsive mb-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Bénédiction</th>
              <th>Lieu</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for mb in membre.benedictions %}
              <tr>
                <td>
                  <input type="hidden" name="mb_id" value="{{ mb.id }}">
                  <select name="mb_benediction_id" class="form-select select2-benediction">
                    <option value="">-- Choisir --</option>
                    {% for b in benedictions %}
                      <option value="{{ b.id }}" {% if mb.benediction_id == b.id %}selected{% endif %}>{{ b.nom }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="text" name="mb_lieu" class="form-control"
                         value="{{ mb.lieu or '' }}">
                </td>
                <td>
                  <input type="date" name="mb_date" class="form-control"
                         value="{{ mb.date_obtention.isoformat() if mb.date_obtention else '' }}">
                </td>
              </tr>
            {% endfor %}

            <!-- Lignes vides pour nouvelles bénédictions -->
            {% for i in range(1) %}
              <tr>
                <td>
                  <input type="hidden" name="mb_id" value="">
                  <select name="mb_benediction_id" class="form-select select2-benediction">
                    <option value="">-- Choisir --</option>
                    {% for b in benedictions %}
                      <option value="{{ b.id }}">{{ b.nom }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="text" name="mb_lieu" class="form-control">
                </td>
                <td>
                  <input type="date" name="mb_date" class="form-control">
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <hr class="my-4">

      <h5 class="mb-3">Talents</h5>
      <p class="text-muted">
        Pour <strong>supprimer</strong> une ligne, effacez le talent et le commentaire.
      </p>

      <div class="table-responsive mb-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Talent</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody>
            {% for mt in membre.talents %}
              <tr>
                <td>
                  <input type="hidden" name="mt_id" value="{{ mt.id }}">
                  <select name="mt_talent_id" class="form-select select2-talent">
                    <option value="">-- Choisir --</option>
                    {% for t in talents %}
                      <option value="{{ t.id }}" {% if mt.talent_id == t.id %}selected{% endif %}>{{ t.nom }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="text" name="mt_commentaire" class="form-control"
                         value="{{ mt.commentaire or '' }}">
                </td>
              </tr>
            {% endfor %}

            <!-- Lignes vides pour nouveaux talents -->
            {% for i in range(2) %}
              <tr>
                <td>
                  <input type="hidden" name="mt_id" value="">
                  <select name="mt_talent_id" class="form-select select2-talent">
                    <option value="">-- Choisir --</option>
                    {% for t in talents %}
                      <option value="{{ t.id }}">{{ t.nom }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="text" name="mt_commentaire" class="form-control">
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <button type="submit" class="btn btn-primary">Enregistrer</button>
      <a href="{{ url_for('liste_membres') }}" class="btn btn-secondary">Annuler</a>

    </div>
  </form>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(function() {
    $('.select2-benediction').select2({
      width: '100%',
      placeholder: '-- Choisir --',
      allowClear: true
    });
    $('.select2-talent').select2({
      width: '100%',
      placeholder: '-- Choisir --',
      allowClear: true
    });
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const chk = document.getElementById('est_mort');
  const dateMort = document.getElementById('date_mort_affichage');

  if (chk && dateMort) {
    chk.addEventListener('change', function () {
      if (this.checked) {
        const today = new Date().toISOString().slice(0, 10);
        if (!dateMort.value) {
          dateMort.value = today;
        }
      } else {
        dateMort.value = "";
      }
    });
  }
});
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    .select2-container .select2-selection--single {
      height: 38px;
      padding: 4px 8px;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 28px;
    }
  </style>
{% endblock %}

