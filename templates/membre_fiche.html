{% extends "base.html" %}

{% block title %}Fiche membre {{ membre.matricule }} - {{ membre.nom }}{% endblock %}

{% block content %}

  <div class="no-print mb-3 d-flex justify-content-between align-items-center">
  <a href="{{ url_for('liste_membres') }}" class="btn btn-link">&larr; Retour √† la liste</a>
  <div class="d-flex gap-2">
    <a href="{{ url_for('membre_fiche_xlsx', matricule=membre.matricule) }}"
       class="btn btn-outline-success btn-sm">
      Export XLSX
    </a>
    <a href="{{ url_for('membre_fiche_pdf', matricule=membre.matricule) }}"
       class="btn btn-outline-danger btn-sm">
      Export PDF
    </a>
    <button class="btn btn-primary btn-sm" onclick="window.print()">üñ® Imprimer (navigateur)</button>
  </div>
</div>


  <div class="card">
    <div class="card-body">

      <h2 class="mb-3">Fiche membre : {{ membre.matricule }} - {{ membre.nom }}</h2>
      
      <div class="col-md-3">
	    {% if membre.photo %}
	      <img src="{{ url_for('static', filename='uploads/membres/' ~ membre.photo) }}"
		   alt="Photo de {{ membre.nom }}"
		   class="img-thumbnail mb-2"
		   style="max-width: 200px;">
	    {% else %}
	      <div class="border rounded text-center p-3 text-muted">
		Aucune photo
	      </div>
	    {% endif %}
	  </div>

      <!-- IDENTIT√â / COORDONN√âES -->
      <div class="row mb-3">
        <div class="col-md-4">
          <h4>Identit√©</h4>
          <p class="mb-1"><strong>Civilit√© :</strong> {{ membre.civilite or '' }}</p>
          <p class="mb-1"><strong>Nom & pr√©noms:</strong> {{ membre.nom }}</p>
          <p class="mb-1"><strong>Matricule :</strong> {{ membre.matricule }}</p>
          <p><strong>Date de naissance :</strong> {{ membre.date_naissance }}</p>
          <p class="mb-1"><strong>Famille :</strong> {{ membre.famille.nom if membre.famille else '' }}</p>
          <p class="mb-1"><strong>Type :</strong> {{ membre.type_membre or '' }}</p>
          
        </div>
        
        <div class="col-md-4">
          <h4>Coordonn√©es</h4>
          
          {% if derniere_inscription %}
            <p class="mb-1"><strong>Adresse :</strong> {{ derniere_inscription.adresse or '' }}</p>
            <p class="mb-1">
              <strong>Faritra :</strong>
              {{ derniere_inscription.faritra.nom if derniere_inscription.faritra else '' }}
            </p>
            <p class="mb-1"><strong>T√©l√©phone :</strong> {{ derniere_inscription.telephone or '' }}</p>
          {% endif %}
          <p class="mb-1"><strong>Carte :</strong> {{ 'Oui' if membre.carte else 'Non' }}</p>
          <p class="mb-1"><strong>Souhaite une carte :</strong> {{ 'Oui' if membre.souhait_avoir_carte else 'Non' }}</p>
        </div>
        
        <div class="col-md-4">
            

	    <p>
	      <strong>Date de d√©part :</strong>
	      {{ membre.date_depart if membre.date_depart else '‚Äî' }}
	    </p>

	    <p>
	      <strong>Statut :</strong>
	      {% if membre.est_mort %}
		<span class="badge bg-danger">D√âC√âD√â</span>
		{% if membre.date_mort %}
		  (le {{ membre.date_mort }})
		{% endif %}
	      {% else %}
		<span class="badge bg-success">Actif / vivant</span>
	      {% endif %}
	    </p>

	    {% if membre.commentaire %}
	      <p><strong>Commentaire :</strong><br>{{ membre.commentaire|nl2br }}</p>
	    {% endif %}
        </div>
      </div>

      <hr>

      <!-- STATUT -->
      <div class="row mb-3">
        <div class="col-md-6">
          <h4>Statut</h4>
          <p class="mb-1"><strong>Date inscription :</strong> {{ membre.date_inscription or '' }}</p>
          <p class="mb-1"><strong>Date d√©part :</strong> {{ membre.date_depart or '' }}</p>
          <p class="mb-1"><strong>Est mort :</strong> {{ 'Oui' if membre.est_mort else 'Non' }}</p>
          <p class="mb-1"><strong>Date mort :</strong> {{ membre.date_mort or '' }}</p>
          <p class="mb-1"><strong>Derni√®re mise √† jour :</strong> {{ membre.date_mise_a_jour or '' }}</p>
        </div>
      </div>

      <hr>

      <!-- B√âN√âDICTIONS -->
      <h4 class="mb-2">B√©n√©dictions</h4>
      <div class="table-responsive mb-3">
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>B√©n√©diction</th>
              <th>Lieu</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for mb in membre.benedictions %}
              <tr>
                <td>{{ mb.benediction.nom if mb.benediction else '' }}</td>
                <td>{{ mb.lieu or '' }}</td>
                <td>{{ mb.date_obtention or '' }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="3" class="text-center text-muted">Aucune b√©n√©diction enregistr√©e.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- TALENTS -->
      <h4 class="mb-2">Talents</h4>
      <div class="table-responsive mb-4">
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>Talent</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody>
            {% for mt in membre.talents %}
              <tr>
                <td>{{ mt.talent.nom if mt.talent else '' }}</td>
                <td>{{ mt.commentaire or '' }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="2" class="text-center text-muted">Aucun talent enregistr√©.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <hr>

      <!-- HISTORIQUE DES SESSIONS / MINIST√àRES -->
      <h4 class="mb-3">Historique des sessions, minist√®res et r√¥les</h4>

      {% if inscriptions_tries %}
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 10%;">Session</th>
                <th style="width: 20%;">P√©riode</th>
                <th style="width: 25%;">Infos inscription</th>
                <th style="width: 45%;">Minist√®res & r√¥les</th>
              </tr>
            </thead>
            <tbody>
              {% for ins in inscriptions_tries %}
                {% set s = ins.session %}
                <tr>
                  <td>
                    {% if s %}
                      #{{ s.id }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if s %}
                      Du {{ s.date_debut or '' }} au {{ s.date_fin or '' }}
                      <br>
                      {% if s.active %}
                        <span class="badge bg-success">Active</span>
                      {% endif %}
                      {% if s.est_cloture %}
                        <span class="badge bg-danger">Cl√¥tur√©e</span>
                      {% endif %}
                    {% endif %}
                  </td>
                  <td>
                    <div><strong>Adresse :</strong> {{ ins.adresse or '' }}</div>
                    <div>
                      <strong>Faritra :</strong>
                      {{ ins.faritra.nom if ins.faritra else '' }}
                    </div>
                    <div><strong>T√©l :</strong> {{ ins.telephone or '' }}</div>
                    {% if ins.responsable %}
                      <div><strong>Responsable :</strong> {{ ins.responsable.nom }}</div>
                    {% endif %}
                  </td>
                  <td>
                    {% if s and ministeres_par_session.get(s.id) %}
                      <ul class="mb-0">
                        {% for mr in ministeres_par_session.get(s.id) %}
                          <li>
                            <strong>{{ mr.ministere or mr["ministere"] }}</strong>
                            {% set role_nom = mr.role or mr["role"] %}
                            {% if role_nom %}
                              - <em>{{ role_nom }}</em>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <span class="text-muted">Aucun minist√®re enregistr√© pour cette session.</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted">
          Aucune session d'inscription enregistr√©e pour ce membre.
        </p>
      {% endif %}

    </div>
  </div>

</div>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Mise en page A4 friendly */
    @page {
      size: A4;
      margin: 15mm;
    }
    @media print {
      .no-print {
        display: none !important;
      }
      body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .card {
        border: none;
        box-shadow: none;
      }
    }
  </style>
{% endblock %}

