{% extends "base.html" %}

{% block title %}Importation des membres{% endblock %}

{% block content %}

<h1 class="mb-3">Importation des membres (CSV)</h1>

<p class="text-muted">
  Le fichier doit contenir au minimum les colonnes :
  <code>matricule, nom, adresse, téléphone, Faritra_id, benediction</code><br>
  Colonnes optionnelles :
  <code>type, civilite, famille, responsable</code>.<br>
  Civilité automatique :
  <code>V... → Mme</code>,
  <code>L... → Mr</code> si la colonne "civilite" est vide.
</p>

{% if session_active %}
  <div class="alert alert-info py-2">
    Session active :
    <strong>{{ session_active.id }}</strong>
    ({{ session_active.date_debut }} → {{ session_active.date_fin }})
  </div>
{% endif %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mt-2">
      {% for cat, msg in messages %}
        <div class="alert alert-{{ 'danger' if cat == 'error' else cat }} 
                     alert-dismissible fade show" role="alert">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form method="post"
      action="{{ url_for('admin_delete_all_membres') }}"
      onsubmit="return confirm('⚠️ SUPPRESSION TOTALE : Ceci va supprimer TOUS les membres et les affectations ministérielles. Continuer ?');">
  <button type="submit" class="btn btn-sm btn-outline-danger">
    Supprimer TOUS les membres
  </button>
</form>

<!-- FORM IMPORT -->
<form method="post" enctype="multipart/form-data" class="card mt-3">
  <div class="card-body">

    <div class="mb-3">
      <label class="form-label">Fichier CSV</label>
      <input type="file" name="fichier" class="form-control" accept=".csv,.txt" required>
      <small class="text-muted">
        Séparateurs acceptés : point-virgule, virgule ou tabulation. Encodage UTF-8 recommandé.
      </small>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input"
             type="checkbox"
             name="simulation"
             id="simulation"
             value="1"
             {% if stats and stats.simulation %}checked{% endif %}>
      <label class="form-check-label" for="simulation">
        Mode simulation (ne pas enregistrer en base)
      </label>
    </div>

    <button type="submit" class="btn btn-primary">
      Lancer l'import
    </button>

    <a href="{{ url_for('liste_membres') }}" class="btn btn-link">
      Retour à la liste des membres
    </a>

  </div>
</form>

<!-- RESULTATS DE L'IMPORT -->
{% if stats %}
  <div class="card mt-4">
    <div class="card-header">
      Résultat de l'import
      {% if stats.simulation %}
        <span class="badge bg-warning text-dark ms-2">Simulation uniquement</span>
      {% else %}
        <span class="badge bg-success ms-2">Enregistré en base</span>
      {% endif %}
    </div>

    <div class="card-body">
      <ul>
        <li>{{ stats.membres_crees }} membre(s) créé(s)</li>
        <li>{{ stats.membres_mis_a_jour }} membre(s) mis à jour</li>
        <li>{{ stats.inscriptions_creees }} inscription(s) créées dans la session active</li>
        <li>{{ stats.benedictions_ajoutees }} bénédiction(s) associée(s)</li>
        <li>{{ stats.nb_success }} lignes importées avec succès</li>
        <li>{{ stats.nb_erreurs }} lignes en erreur</li>
      </ul>

      <div class="mt-3 d-flex flex-wrap gap-2">

        {% if stats.nb_success > 0 %}
        <a href="{{ url_for('import_membres_export', type='success') }}"
           class="btn btn-sm btn-outline-success">
          Télécharger les lignes OK (CSV)
        </a>
        {% endif %}

        {% if stats.nb_erreurs > 0 %}
        <a href="{{ url_for('import_membres_export', type='errors') }}"
           class="btn btn-sm btn-outline-danger">
          Télécharger les lignes en erreur (CSV)
        </a>
        {% endif %}

        {% if stats.nb_success + stats.nb_erreurs > 0 %}
        <a href="{{ url_for('import_membres_export', type='all') }}"
           class="btn btn-sm btn-outline-primary">
          Télécharger rapport complet (CSV)
        </a>
        {% endif %}

      </div>
    </div>
  </div>
{% endif %}

<!-- LIGNES SUCCES -->
{% if success_rows and success_rows|length > 0 %}
  <div class="card mt-4">
    <div class="card-header bg-success text-white">
      Lignes importées avec succès ({{ success_rows|length }})
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Ligne</th>
              <th>Matricule</th>
              <th>Nom</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for s in success_rows %}
            <tr class="table-success">
              <td>{{ s.ligne }}</td>
              <td>{{ s.matricule }}</td>
              <td>{{ s.nom }}</td>
              <td>{{ s.action }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="p-2 text-muted small">
        Ces lignes ont été traitées sans erreur bloquante
        {% if stats and stats.simulation %}(simulation).{% endif %}
      </div>
    </div>
  </div>
{% endif %}

<!-- LIGNES ERREURS -->
{% if errors and errors|length > 0 %}
  <div class="card mt-4">
    <div class="card-header bg-danger text-white">
      Lignes en erreur ({{ errors|length }})
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Ligne</th>
              <th>Matricule</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody>
            {% for e in errors %}
            <tr class="table-danger">
              <td>{{ e.ligne }}</td>
              <td>{{ e.matricule }}</td>
              <td>{{ e.message }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="p-2 text-muted small">
        Corrigez ces lignes dans votre CSV puis relancez l'import.
      </div>
    </div>
  </div>
{% endif %}

{% endblock %}

